#include "luanetlib.h"#include "luaiolib.h"#include "../nwlib/nw.h"#include "../lua/lauxlib.h"#define METATABLE_SRV "LUAIO_NETLIB.SRV"static int netlib_SRV_accept(lua_State* L){	scka *s = luaL_checkudata(L,1,METATABLE_SRV);	int sock = nw_accept(*s);	if(sock<0)return 0;	liolib_pushfd(L,sock);	return 1;}static int netlib_SRV_close(lua_State* L){	scka *s = luaL_checkudata(L,1,METATABLE_SRV);	close(s->sock);	return 0;}static void netlib_SRV(lua_State* L){	if(luaL_newmetatable(L,METATABLE_SRV)){		int top = lua_gettop(L);		lua_newtable(L);		lua_pushcfunction(L,netlib_SRV_accept);		lua_setfield(L,top+1,"accept");		lua_pushcfunction(L,netlib_SRV_close);		lua_setfield(L,top+1,"close");		lua_setfield(L,top,"__index");		lua_settop(L,top);	}}static void netlib_push_srv(lua_State* L,scka s){	scka* s2 = lua_newuserdata(L,sizeof(scka));	int top = lua_gettop(L);	*s2=s;	netlib_SRV(L);	lua_setmetatable(L,top);}static int netlib_connect4(lua_State* L){	const char* ip = luaL_checkstring (L,1);	luaL_checktype(L,2,LUA_TNUMBER);	int port = lua_tointeger(L,2);	int socket = nw_connect_in4(ip,port);	if(socket<0) return 0;	liolib_pushfd(L,socket);	return 1;}static int netlib_connect6(lua_State* L){	const char* ip = luaL_checkstring (L,1);	luaL_checktype(L,2,LUA_TNUMBER);	int port = lua_tointeger(L,2);	int socket = nw_connect_in6(ip,port);	if(socket<0) return 0;	liolib_pushfd(L,socket);	return 1;}static int netlib_connect_u(lua_State* L){	const char* sn = luaL_checkstring (L,1);	int socket = nw_connect_unix(sn);	if(socket<0) return 0;	liolib_pushfd(L,socket);	return 1;}static int netlib_listen4(lua_State* L){	const char* ip = luaL_checkstring (L,1);	luaL_checktype(L,2,LUA_TNUMBER);	int port = lua_tointeger(L,2);	scka socket = nw_listen_in4(ip,port);	if(socket.sock<0) return 0;	netlib_push_srv(L,socket);	return 1;}static int netlib_listen6(lua_State* L){	const char* ip = luaL_checkstring (L,1);	luaL_checktype(L,2,LUA_TNUMBER);	int port = lua_tointeger(L,2);	scka socket = nw_listen_in6(ip,port);	if(socket.sock<0) return 0;	netlib_push_srv(L,socket);	return 1;}static int netlib_listen_u(lua_State* L){	const char* sn = luaL_checkstring (L,1);	scka socket = nw_listen_unix(sn);	if(socket.sock<0) return 0;	netlib_push_srv(L,socket);	return 1;}void netlib_install(lua_State* L){	lua_register(L,"connect_in4",netlib_connect4);	lua_register(L,"connect_in6",netlib_connect6);	lua_register(L,"connect_unix",netlib_connect_u);	lua_register(L,"listen_in4",netlib_listen4);	lua_register(L,"listen_in6",netlib_listen6);	lua_register(L,"listen_unix",netlib_listen_u);}